# PHASE 16: ARCHITECTURE EVOLUTION & FLATTENING (SOTA 2026)

## Objective
To evolve the Growin App's Multi-Agent System (MAS) based on 2026 State-of-the-Art (SOTA) research and unfinished objectives from the `01-mas-evolution` phase. We aim to flatten the hierarchical structure (merging Decision and Coordinator layers to reduce latency), implement AG-UI streaming via the existing `AgentMessenger`, and introduce a dedicated Risk/Compliance layer with robust HITL gates.

## 1. Core Architectural Shifts
- **The Master Orchestrator**: Merge the current `DecisionAgent` and `CoordinatorAgent` into a unified top-level router. This agent will directly interface with the user, orchestrate the swarm in parallel via the `AgentMessenger` bus, and synthesize the final CoT reasoning. This eliminates a redundant LLM hop and leverages the decentralized communication bus established in earlier MAS iterations.
- **Risk & Compliance Agent**: Integrate a strict "Critic Pattern." All final trading suggestions generated by the Orchestrator must be vetted by a local Risk/Compliance Agent before being shown to the user. This fulfills the "refactor agent permissions" objective from Phase 2 of MAS Evolution.
- **AG-UI Protocol**: Upgrade the `AgentMessenger` broadcasting logic to provide real-time, granular "Reasoning Traces" (Agent states) to the Swift frontend. This replaces the percieved wait state with transparent swarm execution.
- **Hardware Optimization (M4 Pro)**: Ensure the new Orchestrator and Risk agents are optimized for local inference, continuing the 8-bit AFFINE quantization work started previously.

## 2. Implementation Tasks

### Wave 1: The Orchestrator Migration & Hardware Sync
- [ ] Refactor `backend/agents/coordinator_agent.py` and `decision_agent.py` into a unified `OrchestratorAgent.py`.
- [ ] Update `backend/routes/chat_routes.py` to route user inputs directly to the `OrchestratorAgent`.
- [ ] Implement standardized 8-bit AFFINE optimization for the Orchestrator model on M4 Pro.
- [ ] Verify parallel execution of the Specialist Swarm via the `AgentMessenger` bus.

### Wave 2: The Critic Pattern & HITL Enforcement
- [ ] Create `backend/agents/risk_agent.py` to act as the compliance reviewer.
- [ ] Define system prompts for the Risk Agent focusing on exposure limits, account constraints (Invest vs ISA), and volatility checks.
- [ ] Wire the Orchestrator to pass synthesized trading suggestions through the Risk Agent.
- [ ] Implement strict HITL (Human-in-the-Loop) gates in the backend logic, ensuring no trade-triggering response is delivered without a mandatory confirmation block.

### Wave 3: AG-UI Streaming & Frontend Polish
- [ ] Enhance `backend/agents/messenger.py` to broadcast granular AG-UI state changes (e.g., "Swarm initializing", "Risk check in progress").
- [ ] Update `Growin/Views/RichMessageComponents.swift` (specifically the `IntelligenceTraceView`) to dynamically animate these states as they arrive via SSE.
- [ ] Implement the `ConfidenceVisualizationView` in SwiftUI to present the Risk Agent's assessment and the final trade call for user confirmation.

## 3. Risk & Mitigation
- **Risk**: Refactoring the Coordinator and Decision logic might temporarily break the RAG and specialized tool retrieval.
- **Mitigation**: Leverage the existing `TelemetryData` and end-to-end tracing to verify tool call correctness in the new Orchestrator. Rely on `pytest` for `test_decision_robustness.py`.

## Execution Instruction
Execute Wave 1 first to establish performance gains. Prioritize the integration of the existing `AgentMessenger` to maintain the actor-model communication standard.
