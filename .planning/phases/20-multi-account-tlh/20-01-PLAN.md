---
phase: 20
plan: 01
wave: 1
gap_closure: false
---

# Plan 20.01: Multi-Account Foundation & TLH Logic

## Objective
Update PortfolioAgent to calculate consolidated asset weights across all account types and implement the core Tax-Loss Harvesting (TLH) logic to identify offset opportunities.

## Tasks

<task type="auto">
  <name>Multi-Account Aggregator</name>
  <files>
    backend/agents/portfolio_agent.py
    backend/market_context.py
  </files>
  <action>
    Update PortfolioAgent to fetch data from all active accounts (Invest, ISA) via the MCP client.
    Merge identical holdings into a consolidated view, calculating global portfolio weights.
    Update PortfolioData schema to support `accounts_breakdown` and `consolidated_positions`.
  </action>
  <verify>
    uv run pytest backend/tests/test_portfolio_aggregation.py
  </verify>
  <done>
    Agent correctly identifies AAPL held in both ISA and Invest as a single logical position.
  </done>
</task>

<task type="auto">
  <name>Tax-Loss Harvesting Scanner</name>
  <files>
    backend/utils/financial_math.py
    backend/agents/quant_agent.py
  </files>
  <action>
    Implement a TLH scanner that filters for positions in taxable accounts (Invest) with unrealized losses.
    Calculate the offset value. 
  </action>
  <verify>
    uv run pytest backend/tests/test_tlh_scanner.py
  </verify>
  <done>
    Scanner accurately flags positions with >5% unrealized loss for potential harvesting.
  </done>
</task>
