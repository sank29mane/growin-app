---
phase: 12-stability-hardening
plan: 01
type: execute
wave: 1
depends_on: ["11-03"]
files_modified: [
    "Growin/ViewModels/DashboardViewModel.swift",
    "Growin/Views/DashboardView.swift",
    "Growin/CoreModels.swift"
]
autonomous: true
requirements: [STAB-01, STAB-02]
---

<objective>
Resolve the persistent Charts crash by hardening the data pipeline and enforcing strict actor isolation for UI updates.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Harden Chart Data in DashboardViewModel</name>
  <action>
    - Update `calculateAllocationData` in `DashboardViewModel.swift`:
        - Filter out any positions with zero or negative market value.
        - Ensure "Others" category also only appears if its value is strictly positive.
        - Use `Decimal` arithmetic throughout to prevent precision loss before converting to `Double` for the chart.
    - Update `updateChartData` to check for data validity before assignment.
  </action>
</task>

<task type="auto">
  <name>Task 2: Implement Defensive Rendering in DashboardView</name>
  <action>
    - Update `DashboardView.swift`:
        - Add `if item.doubleValue > 0` checks within `SectorMark` blocks.
        - Wrap `Chart` components in a condition that checks if at least one data point is positive.
        - Add logging for any rejected data points to help debug malformed backend responses.
  </action>
</task>

<task type="auto">
  <name>Task 3: Refine Concurrency & Actor Isolation</name>
  <action>
    - Audit `startLiveSync` in `DashboardViewModel.swift`:
        - Ensure `Task` captures `self` correctly and updates only on `@MainActor`.
        - Verify `dataService.fetchPortfolio` is handled correctly within the async context.
    - Update `Growin/CoreModels.swift`:
        - Ensure `Position.id` is truly unique by incorporating `UUID` fallback if ticker is missing.
  </action>
</task>

</tasks>

<verification>
- **Crash Test**: Navigate to Dashboard multiple times with active data sync and verify no crashes.
- **Empty State Test**: Clear backend data and verify Dashboard shows "No Data" or loading state without crashing.
- **Logging**: Verify that invalid data points are logged and skipped rather than rendered.
</verification>
