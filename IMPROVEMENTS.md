# Growin App: Comprehensive Code Audit & Improvement Report (v2)

**Date**: February 6, 2026  
**Auditor**: Gemini AI  
**Previous Audit**: February 2, 2025 (Reference)  
**Status**: Active Development  

---

## Executive Summary

### Overall Code Health Score: **7.5/10** (+0.3 improvement)

Since the last major audit in 2025, the **Growin** codebase has improved in user experience, prompt engineering, and bug fixes (specifically in portfolio aggregation). However, **critical technical debt** identified in the previous audit remains largely unaddressed, particularly regarding financial precision and security/compliance.

New architectural analysis reveals a sophisticated but complex "Coordinator-Specialist" pattern that introduces its own set of risks (LLM code execution) and bottlenecks (latency).

### Status Update (vs 2025 Report)

| Issue | Priority | Status | Notes |
|-------|----------|--------|-------|
| **Wrong Values / Cash Bug** | Critical | âœ… **FIXED** | Fixed Jan 2026. Account filtering logic corrected. |
| **Thinking Artifacts** | High | âœ… **FIXED** | Fixed Jan 2026. `_clean_response` implemented. |
| **UX / Formatting** | Medium | âœ… **FIXED** | Conversational tone and Quick Actions added. |
| **Float Arithmetic** | Critical | âŒ **OPEN** | Financial calcs still use `float`. |
| **API Key Exposure** | Critical | âŒ **OPEN** | No masking middleware found in `server.py`. |
| **Missing Audit Trails** | Critical | âŒ **OPEN** | No structured audit logging found. |

---

## Critical Issues (Immediate Action Required)

### ðŸ”´ CRITICAL-1: Float Arithmetic in Financial Calculations (Persistent)
**Location**: `backend/quant_engine.py`, `backend/agents/portfolio_agent.py`  
**Risk**: High (Financial Accuracy)

The codebase continues to use Python `float` for currency calculations.
- **Evidence**: `total_value = sum(pos['qty'] * pos['current_price'] ...)` in `QuantEngine`.
- **Impact**: Accumulation of binary floating-point errors (e.g., `0.1 + 0.2 != 0.3`).
- **Remediation**: Migrate to `decimal.Decimal` for all P&L, price, and balance calculations.

### ðŸ”´ CRITICAL-2: Sandbox Security / LLM Code Execution (New)
**Location**: `backend/agents/coordinator_agent.py`, `backend/utils/safe_python.py`  
**Risk**: High (Security)

The `CoordinatorAgent` executes Python code generated by the LLM to "fix" contexts (Self-Healing).
- **Evidence**: `exec_res = self.python_executor.execute(python_code, ...)`
- **Mitigation**: `SafePythonExecutor` uses AST analysis and `exec` with restricted globals.
- **Vulnerability**: While mitigated, `exec` is inherently dangerous. A sophisticated prompt injection could potentially bypass the AST filter or abuse the allowed modules (`math`, `statistics`) to cause denial of service (DoS) or memory exhaustion, despite the timeout.
- **Remediation**: 
    1.  Replace `exec` with deterministic logic or a rule engine where possible.
    2.  If code execution is mandatory, move it to a completely isolated Docker container or WASM sandbox, not just a restricted Python scope.

### ðŸ”´ CRITICAL-3: Missing Secret Masking (Persistent)
**Location**: `backend/server.py`, `backend/mcp_client.py`  
**Risk**: High (Credential Leakage)

Logs may contain API keys, especially when MCP servers are connected or errors occur in `t212_handlers.py`.
- **Evidence**: `server.py` initializes logging but lacks the `SecretMasker` middleware proposed in 2025.
- **Remediation**: Implement the `SecretMasker` utility and attach it to the `logging` formatter and FastAPI middleware.

---

## High-Priority Architecture Improvements

### ðŸŸ¡ HIGH-1: Global State Management
**Location**: `backend/app_context.py`, `backend/server.py`

The application relies heavily on a global `state` object imported from `app_context`.
- **Issue**: Makes testing difficult (tests interact with the same global instance) and complicates concurrency.
- **Recommendation**: Refactor to Dependency Injection. Pass `AppState` explicitly to route handlers and agents.

### ðŸŸ¡ HIGH-2: Ticker Normalization Scattering
**Location**: `CoordinatorAgent`, `trading212_mcp_server`, `DataFabricator`

Ticker normalization logic (e.g., `lloy` -> `LLOY.L`) is duplicated or scattered.
- **Evidence**: `CoordinatorAgent` has custom regex/search logic. `trading212_mcp_server` has `normalize_ticker`. `DataFabricator` also does normalization.
- **Recommendation**: Centralize all ticker logic into a single authoritative `TickerService` or `TickerUtils` module.

### ðŸŸ¡ HIGH-3: Latency & Response Streaming
**Location**: `backend/routes/chat_routes.py`

The request pipeline is synchronous and multi-stage (Coordinator -> Specialist -> Decision).
- **Issue**: Users wait 5-10s+ for a response with no feedback.
- **Recommendation**: Implement Server-Sent Events (SSE) or WebSocket to stream status updates ("Analyzing...", "Fetching Price...") and tokens to the frontend.

---

## Roadmap for Next Sprint

1.  **Safety First**: Implement `SecretMasker` to secure logs.
2.  **Precision**: Migrate `QuantEngine` to `Decimal`.
3.  **Security**: Harden `SafePythonExecutor` or replace dynamic code generation with static tools.
4.  **Architecture**: Centralize Ticker Normalization.

---

## Appendix: 2026 Audit Notes

- **Codebase Investigator Results**: Confirmed clean separation of IO (DataFabricator) but highlighted the `python_executor` risk.
- **Performance**: Apple Silicon (ANE) optimization is correctly configured in `server.py`.
- **Dependencies**: Project uses `uv` (modern, fast). `requirements.txt` and `pyproject.toml` should be kept in sync.