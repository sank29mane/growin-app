# Growin App Multi-Agent System: Architecture Evolution (SOTA 2026)

## 1. Executive Summary
As of Phase 16, the Growin App has transitioned from a hierarchical, multi-hop Multi-Agent System (MAS) to a flattened, high-performance architecture. This evolution eliminates redundant LLM reasoning stages, implements strict risk governance via the **Critic Pattern**, and leverages **8-bit AFFINE hardware acceleration** for Apple Silicon M4 Pro.

## 2. Evolution: From Hierarchical to Flattened

### Previous Architecture (Phase 1-15)
1. **User** -> **Decision Agent**
2. **Decision Agent** -> **Coordinator Agent** (Routing)
3. **Coordinator** -> **Swarm** (Specialists)
4. **Swarm** -> **Coordinator** (Results)
5. **Coordinator** -> **Decision Agent** (Synthesis)
6. **Decision Agent** -> **User** (Final Response)
*Latency: High (~3-5s overhead per hop)*

### Current SOTA 2026 Architecture (Phase 16+)
1. **User** -> **Orchestrator Agent**: Unified entry point for intent classification and final reasoning.
2. **Orchestrator** -> **Specialist Swarm**: Parallel execution of Quant, Research, Portfolio, etc.
3. **Specialist Swarm** -> **Orchestrator**: Raw data injection into MarketContext.
4. **Orchestrator** -> **Risk Agent (Critic)**: Mandatory audit of the proposed strategy.
5. **Risk Agent** -> **Orchestrator**: Compliance approval or risk flagging.
6. **Orchestrator** -> **User**: Unified response with real-time AG-UI streaming.
*Latency: Optimized (<500ms routing overhead)*

## 3. Core SOTA Components

### A. The Unified Orchestrator (`orchestrator_agent.py`)
Merges the functions of the previous Decision and Coordinator agents. It manages the full lifecycle:
- **Intent Classification**: Uses lightweight models (Granite-Tiny) for sub-100ms routing.
- **Data Fabrication**: Orchestrates the Specialist Swarm via `asyncio.gather`.
- **Reasoning**: Performs final synthesis and strategy generation.

### B. The Critic Pattern (`risk_agent.py`)
Implements mandatory governance. Every strategy synthesized by the Orchestrator must pass through the Risk Agent for:
- **Exposure Auditing**: Checking portfolio concentration limits.
- **Compliance Validation**: Ensuring ISA/Invest rules are respected.
- **Volatility Analysis**: Flagging trades during extreme market conditions.

### C. 8-bit AFFINE Hardware Optimization
Optimized for Apple Silicon M4 Pro (NPU/GPU):
- **AFFINE Quantization**: Implemented in `mlx_engine.py` to maximize throughput while maintaining reasoning precision.
- **NPU Affinity**: Routing models are pinned to the ANE (Apple Neural Engine) to free the GPU for large-model reasoning.

### D. AG-UI Streaming Protocol
Real-time transparency via `AgentMessenger`:
- **Granular Telemetry**: Broadcasts `intent_classified`, `swarm_started`, and `risk_review_started` events.
- **SwiftUI Integration**: Live reasoning traces using `PhaseAnimator` for fluid, transparent AI thought visualization.

## 4. Governance & Safety Gates

### Human-in-the-Loop (HITL) Enforcement
Trading execution is protected by a dual-layered gate:
1. **Agent Gate**: Risk Agent appends `[ACTION_REQUIRED:TRADE_APPROVAL]` to any sensitive suggestion.
2. **Backend Gate**: `/mcp/tool/call` requires a signed HMAC `approval_token` generated by the UI after explicit user confirmation.

---
*Status: IMPLEMENTED (March 2026)*
