# Growin App: Comprehensive Code Audit & Improvement Report (v2)

**Date**: February 6, 2026  
**Auditor**: Gemini AI  
**Previous Audit**: February 2, 2025 (Reference)  
**Status**: Active Development  

---

## Executive Summary

### Overall Code Health Score: **7.5/10** (+0.3 improvement)

Since the last major audit in 2025, the **Growin** codebase has improved in user experience, prompt engineering, and bug fixes (specifically in portfolio aggregation). However, **critical technical debt** identified in the previous audit remains largely unaddressed, particularly regarding financial precision and security/compliance.

New architectural analysis reveals a sophisticated but complex "Coordinator-Specialist" pattern that introduces its own set of risks (LLM code execution) and bottlenecks (latency).

### Status Update (vs 2025 Report)

| Issue | Priority | Status | Notes |
|-------|----------|--------|-------|
| **Wrong Values / Cash Bug** | Critical | âœ… **FIXED** | Fixed Jan 2026. Account filtering logic corrected. |
| **Thinking Artifacts** | High | âœ… **FIXED** | Fixed Jan 2026. `_clean_response` implemented. |
| **UX / Formatting** | Medium | âœ… **FIXED** | Conversational tone and Quick Actions added. |
| **Float Arithmetic** | Critical | âŒ **OPEN** | Financial calcs still use `float`. |
| **API Key Exposure** | Critical | âœ… **FIXED** | `SecretMasker` middleware implemented (Feb 2026). |
| **Missing Audit Trails** | Critical | âŒ **OPEN** | No structured audit logging found. |

---

## Critical Issues (Immediate Action Required)

### ðŸ”´ CRITICAL-1: Float Arithmetic in Financial Calculations (Persistent)
**Location**: `backend/quant_engine.py`, `backend/agents/portfolio_agent.py`  
**Risk**: High (Financial Accuracy)

The codebase continues to use Python `float` for currency calculations.
- **Evidence**: `total_value = sum(pos['qty'] * pos['current_price'] ...)` in `QuantEngine`.
- **Impact**: Accumulation of binary floating-point errors (e.g., `0.1 + 0.2 != 0.3`).
- **Remediation**: Migrate to `decimal.Decimal` for all P&L, price, and balance calculations.

### ðŸ”´ CRITICAL-2: Sandbox Security / LLM Code Execution (New)
**Location**: `backend/agents/coordinator_agent.py`, `backend/utils/safe_python.py`  
**Risk**: High (Security)

The `CoordinatorAgent` executes Python code generated by the LLM to "fix" contexts (Self-Healing).
- **Evidence**: `exec_res = self.python_executor.execute(python_code, ...)`
- **Mitigation**: `SafePythonExecutor` uses AST analysis and `exec` with restricted globals.
- **Vulnerability**: While mitigated, `exec` is inherently dangerous. A sophisticated prompt injection could potentially bypass the AST filter or abuse the allowed modules (`math`, `statistics`) to cause denial of service (DoS) or memory exhaustion, despite the timeout.
- **Remediation**: 
    1.  Replace `exec` with deterministic logic or a rule engine where possible.
    2.  If code execution is mandatory, move it to a completely isolated Docker container or WASM sandbox, not just a restricted Python scope.

### ðŸŸ¢ FIXED: API Key Exposure
**Location**: `backend/utils/secret_masker.py`, `backend/app_logging.py`
**Status**: âœ… Fixed (Feb 6, 2026)

The `SecretMasker` utility has been implemented to scrub sensitive patterns (API keys, JWTs) from logs.
- **Implementation**: Regex-based masking hooked into the logging formatter.
- **Verification**: Tests in `backend/tests/test_logging_safety.py`.

### ðŸ”´ CRITICAL-3: Missing Audit Trails (Persistent)

---

## High-Priority Architecture Improvements

### ðŸŸ¡ HIGH-1: Global State Management
**Location**: `backend/app_context.py`, `backend/server.py`

The application relies heavily on a global `state` object imported from `app_context`.
- **Issue**: Makes testing difficult (tests interact with the same global instance) and complicates concurrency.
- **Recommendation**: Refactor to Dependency Injection. Pass `AppState` explicitly to route handlers and agents.

### ðŸŸ¡ HIGH-2: Ticker Normalization Scattering
**Location**: `CoordinatorAgent`, `trading212_mcp_server`, `DataFabricator`

Ticker normalization logic (e.g., `lloy` -> `LLOY.L`) is duplicated or scattered.
- **Evidence**: `CoordinatorAgent` has custom regex/search logic. `trading212_mcp_server` has `normalize_ticker`. `DataFabricator` also does normalization.
- **Recommendation**: Centralize all ticker logic into a single authoritative `TickerService` or `TickerUtils` module.

### ðŸŸ¡ HIGH-3: Latency & Response Streaming
**Location**: `backend/routes/chat_routes.py`

The request pipeline is synchronous and multi-stage (Coordinator -> Specialist -> Decision).
- **Issue**: Users wait 5-10s+ for a response with no feedback.
- **Recommendation**: Implement Server-Sent Events (SSE) or WebSocket to stream status updates ("Analyzing...", "Fetching Price...") and tokens to the frontend.

---

## Roadmap for Next Sprint

1.  **Safety First**: Implement `SecretMasker` to secure logs (Verify Coverage).
2.  **Precision**: Migrate `QuantEngine` to `Decimal` using `utils.financial_math`.
3.  **Security**: Harden `SafePythonExecutor` toward Docker-based isolation.
    - **Implementation**: Transition from AST-validation to the **Docker MCP** plugin for executing agent-generated scripts in isolated `python:3.11-slim` containers.
4.  **Architecture**: Centralize Ticker Normalization in a dedicated service.

---

## ðŸš€ 2026 SOTA Roadmap

### 1. Multi-Agent Observability Dashboard
Implement a structured telemetry system to visualize the reasoning chain.
- **Goal**: Show the user *why* a specific agent was called and what data it returned.
- **Metric**: Track agent latency and token usage per intent type.

### 2. Docker-Native Agent Operations
Move all agentic "Fix" operations to a dedicated Docker Network.
- **Security**: No network egress allowed for "Fix" containers.
- **Lifecycle**: Containers are destroyed immediately after execution to prevent persistence.

### 2. Phased Autonomy (HITL)
Transition from "Advisory" to "Layered Autonomy".
- **Short Term**: Implement "Confirmation Gates" for all trade-related suggestions.
- **Long Term**: Allow agents to perform low-risk maintenance tasks (e.g., auto-rebalancing within 1% threshold) autonomously with audit logs.

### 3. Native Backend Launcher (Frontend)
Refactor `GrowinApp.swift` to use `Process` instead of `NSAppleScript`.
- **Reason**: `NSAppleScript` is fragile and depends on the Terminal app state. `Process` allows for better lifecycle management and log capture.

- **Codebase Investigator Results**: Confirmed clean separation of IO (DataFabricator) but highlighted the `python_executor` risk.
- **Performance**: Apple Silicon (ANE) optimization is correctly configured in `server.py`.
- **Dependencies**: Project uses `uv` (modern, fast). `requirements.txt` and `pyproject.toml` should be kept in sync.